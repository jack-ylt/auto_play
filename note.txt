btm 密码 qQ198...


git status
git add .
git commit -m

git push origin master
git push origin multi_client
git push --delete origin branch_name_here

git branch
git checkout

git log
                



主程序逻辑

场景一：一键游戏
    初始化账号列表
    启动多个模拟器
    old_account = None

    对于每个客户端
        try
            account_dict = 登录一个新账号
            old_account = account_dict
        except
            没账号了：exit

        if server_list:
            for 对于每一个服务器
                切换到该的服务器

                玩游戏
        else
            玩游戏

登录一个新账号
    if old_account：
        获取一个账号（指定游戏名）
        if 成功：
            登录
        else
            关闭游戏
            获取一个账号
            根据游戏名，启动游戏
            登录
    else
        获取一个账号
        根据游戏名，启动游戏
        登录
        



模板匹配，会因为大小不同，分辨率不同，匹配失败
    试试特征点匹配


很多按钮突然识别不了了，应该是按钮的指纹变了
=》 可能是截图完整的按钮没问题，只截文字有问题 （文字细节会变化）（如果有多个按钮，可能会误识别）
=》 使用其他标志图标，然后，按位置点击


★ 如何实现一键游戏，做到完全省心？
    图像识别准确
    每个逻辑都独立，并覆盖所有情况
    每个任务都可以配置，做到遵循玩家意愿
    结束后，有个报告，告知任务完成情况，让玩家放心
    即使出现问题，也不影响别的
    出现预料之外的情况，有记录，可追溯
    出现游戏bug，无响应等异常，能重启游戏


开发中遇到的阻碍：
    很多情况没有考虑到
    -》 伪代码

    截图太麻烦
    -> 截有特色的, 使用好的截图软件

    api记不住
    -> Shpinx 自动生成项目文档

    代码框架感觉有点混乱了
    -> 重新理一下


main
    创建 recorder
        加载 json 到 dict

    windows_num = 启动模拟器 (如果已经启动，直接返回窗口数)
    根据窗口数，创建玩家 （固定启动4个）
    
    对于每一个玩家，添加协程任务 auto_play
        try:
            角色 = 登录游戏
        except:
            exit

        对于每一个未完成的任务 + 多多益善的任务（根据json）
            try:
                执行任务 （可能用到 role recorder）
            except:
                xxx

            try：
                回主界面
            except：
                重启游戏
        
    退出之前：
        dict -> json
        

    登录游戏
        if 在主界面了
            if 角色为空
                role = 获取登录的角色名 (退出，复制用户名)
                绑定角色
            else
                role = apply_new_role
                重新登录 role
        else (游戏未启动)
            启动游戏，自动登录游戏
            role = 获取登录的角色名
            try：
                绑定角色
            except
                role = apply_new_role
                重新登录 role

        return role

    重新登录
        退出
        登录 role

先实现不要账号密码的

eye，hand
    提供基础api，方便第一，不考虑效率

player
    和window结合，方便auto_play调用，提供缓存，考虑效率

tasks
    利用 player，role 完成每一个任务

login
    启动模拟器，登录游戏

recorder
    记录每个role的任务完成情况
    load
    record
    report

account.cfg
    game_name = mo_shi_jun_tun
    account = aa592729440
    passwd = Qq8738090

setting.cfg 
    [default]
    cfg of all task ...

    [account1]
    cfg of all task ...

    [account2]
    ...

pics 
    bottom
    icon
    pic

支持各种大小的窗口
    截图最大的窗口，然后通过剪切、缩小，得到各种尺寸的图片

每个player有单独的日志记录

写个测试，测试下，使用with的多进程查找 
    估计不会有性能问题
    
没必要把hand、eye分开，直接都集成到player中去，参考pyautogui

★ eye能够自己保存截屏img，过期了就重新截一个，没过期就还用原来的。
不要让player还去考虑并发，公用截屏img的问题。
至于target_img可以使用global_value来缓存

关于配置，可以直接copy default的，取名game_account.cfg，然后用户想改的话，可以自己改

每一个任务，写成类，调用的时候通过配置来

为了能支持快速停止，所有耗时函数，都需要是协程

☆ 研究下别人的代码实现
    img.resize()
    
    屏幕截图，避免保存和读取的过程
        from PIL import ImageGrab
        from io import BytesIO
        import numpy as np
        import cv2

        ## (1) Grab the rgb frame as PIL.Image
        ii = ImageGrab.grab()
        print(type(ii)) # <class 'PIL.Image.Image'>

        ## (2) Convert PIL.Image to np.array
        rgb = np.array(ii)
        print(type(ii)) # <class 'numpy.ndarray'>

        ## (3) Convert into BGR and display
        bgr = cv2.cvtColor(rgb, cv2.COLOR_RGB2BGR)
        # img_gray = cv2.cvtColor(rgb, cv2.COLOR_BGR2GRAY)
        cv2.imshow("frame", bgr)
        cv2.waitKey()
        cv2.destroyAllWindows()
        
    固定区域截图
        box = (x,y,x1,y1)
        im = ImageGrab.grab(box)
    
    像素颜色匹配
        getpixel(pos)
            pix = pyautogui.pixel(100, 200)
            >>> pix
            RGB(red=130, green=135, blue=144)
            
        pixelMatchesColor(pos, (140, 125, 134), tolerance=10)
            >>> pyautogui.pixelMatchesColor(100, 200, (130, 135, 144))
            True
            >>> pyautogui.pixelMatchesColor(100, 200, (140, 125, 134))
            False
            >>> pyautogui.pixelMatchesColor(100, 200, (140, 125, 134), tolerance=10)
            
    debug
        log_screnshort()
        每次操作，都保存操作描述和一个截图对象到队列中（size 10）
        如果发生异常，截屏，并把最近的10个操作的截图写到debug文件夹
        
    api
        position()  # current mouse x and y
        
        onScreen(x, y)  # True if x & y are within the screen.
        
        moveTo(x, y, duration=num_seconds)  # move mouse to XY coordinates over num_second seconds
        
        dragTo(x, y, duration=num_seconds)  # drag mouse to XY
        
        scroll(amount_to_scroll, x=moveToX, y=moveToY)
        
        screenshot()  # returns a Pillow/PIL Image object
        
        screenshot('foo.png')  # returns a Pillow/PIL Image object, and saves it to a file
        >>> pyautogui.locateOnScreen('looksLikeThis.png')  # returns (left, top, width, height) of first place it is found
        (863, 417, 70, 13)
        
        >>> for i in pyautogui.locateAllOnScreen('looksLikeThis.png')
        ...
        ...
        (863, 117, 70, 13)
        (623, 137, 70, 13)
        (853, 577, 70, 13)
        (883, 617, 70, 13)
        (973, 657, 70, 13)
        (933, 877, 70, 13)
        
        >>> pyautogui.locateCenterOnScreen('looksLikeThis.png')  # returns center x and y
        (898, 423)
            
        >>> im.getpixel((100, 200))
        (130, 135, 144)
      
        >>> pyautogui.pixelMatchesColor(100, 200, (140, 125, 134), tolerance=10)
        True
        
        

V1.0


TODO
    发生异常，保存最近10次的屏幕log    done
    给各种查找、操作都加上缓存截图     done
    fix 家园      done
        刚进家园，迷雾没散，点击卡住  done
        点切换地图，地图没弹出来
        识别boos，会误识别
            => 多加几个图片
            滑动后，停0.5s
        _goto_floor 总共7层没问题，但总共是5层呢
        
        战斗，不能用find_all，因为打完一个，下一次回到主界面，位置会变的，需要重新查找
        done
        
        
    
    fix 任务
        """300次必出7星是每天重置的，所有要尽量节约信封,留到人工一次性用来刷7星任务。
        高星任务出现的概率是固定的，一切技巧都是心理作用
        """
        点任务栏
        如果 没有未领任务：
            return
            
        领任务
        完成所有任务 （优先一键领取）
        
        while 还有未领任务:
            try:
                刷新任务
                领任务
            except:
                xxx

        
            
        领任务
            往右滑（划完要停一下），遇到满足要求的就领取
            如果有任务没法领：
                raise
            直到遇到完成，或者解锁，
           
            
        刷新任务
            钻石不足：
                raise

        完成所有任务
            一键领取
            如果失败：
                到最左边
                往右滑（划完要停一下），遇到完成的就领取
                遇到解锁：
                    退出
    
    
    点击的时候，也要截图，否则，图片可能失实    done
    游戏主界面，刚弹出广告，监控到了，点关闭。结果广告才完全出来
    
    图像识别和点击还是有问题，有各种意外
    => 每一个操作都要有确认机制
    
    把图片合并到一个文件夹，不要开发太麻烦了    done
    
    ★ 鼠标双击，经常失灵。
    =》找了半天原因，原来是360导致的。关掉后，又快又好。
    
    ★ 不能有死循环
    所有while True 都要改成 for max_count
    
    物品买了，就变灰色，图像识别到了，又点击怎么办？
    =》
    1 点了，不弹出确认框，就认为买过了
    
    2 加入颜色验证
    pyautogui.pixelMatchesColor(100, 200, (140, 125, 134), tolerance=10)
    True
    
    _goto_floor 不准确，主函数那边要做处理
    
    go_back 失败，
    =》可能是鼠标不在里面，窗口没有处于激活状态
    换成点回退键，点close的方法？
    
    有时候点击失败
    =》点击太快了，游戏未响应   done
    
    log要分开记录，不然不好分析
    
    有不少误识别，需要提高阈值，到0.9？
    
    is_enabled_button(pos, img_rectangle)
        获取左右两边中点的坐标，如果都是绿色，或者都是黄色
        方圆20个像素,随机10个点
            if pyautogui.pixelMatchesColor(x + dx, y, color, tolerance=10):
                return True
        else:
            return False

    go_back => go_back_to   done    
    win 误识别  =>  0.9     done
    
    
    fix 冠军竞技场   done

    fix 勇士塔     done

        塔
        点点点
        while True
            挑战
            战斗
            while
                下一关，邀请英雄、快进、结束、
                if 下一关
                    break
                if 邀请英雄:
                    ok
                    return

            
            




    
    fix 市场  done
        点市场
        金币、钻石
        领幸存奖励
            back
        while True
            买东西
            刷新， 如果要钻石，则退出
        买高级东西
        
    
    fix 勇者  done
        勇者副本
        当前关卡
        
        挑战
        如果没兵
            派兵
            
        while true:
            开始战斗
            战斗
                    
            如果win
                下一关卡，确定
                    if下一关卡
                        就点下一关卡，点挑战
                    if确定
                        就点确定，找当前关卡
                    点挑战
            else：
                点ok
                
        战斗
            while：
                卡片，lose 结束 快进
                如果 快进，结束：
                    点击
                卡片
                    点两次，return win
                lose
                    return lose
                sleep 1
            
        
    
    fix 公会战



鼠标点击失灵
    -> 双击失灵，卸载360，解决了
    -> 单击偶尔也失灵
        -> 管理员身份运行
        -> 先move_to再click
        
    家园boos，有些特殊的位置就是点不了
    =》改成精确点boos图标
    
    
log 要分开打印
上层要捕获异常，不能让程序直接崩溃
    def make_logger(name):
        handler = logging.FileHandler(filename=name + ".log")
        logger = logging.getLogger(name)
        logger.addHandler(handler)
        logger.setLevel(logging.INFO)
        return logger
    logger = make_logger("a")

    auto_play, player_eye, hand 都用player的logger （使用属性，传参的方式公用）
    player的logger根据角色名或者窗口名创建
    其它用main的logger

threshold=0.8, timeout=10, delay=1
因为有个函数threshold设置为了0.7，导致了各种bug，很难排查
=> 这些值统一配置，不要弄得到处都是

There are more than one hundred pictures in total
Does anyone know: how to upload pictures in bulk?



游戏名字，任务名字，用中文拼音更好。

可以进一步细分 bbox，提高识别速度和正确率
    1/4 的box 在上下左右，中，以及四个角落，9块区域

很多click，光sleep不行，因为有时候快，有时候慢。所以要检测程序是否响应click完成

click card 第二次要等卡片翻过来，再点击


某一个任务异常了，加到末尾，到时候再试一次，count++       done
回不到主界面，重启游戏     done




Tasks 类
    test()
    run()
    
XianShiJie
    goto_gkzd
        move_to_center
    collect_box
        find rank
        receive
        if upgrade
            if find setting:
                goto_gkzd
            else:
                pass
    
    while True:
        try:
            goto_next_level
                upgrade
                    if find setting:
                        goto_gkzd
                        goto_next_level
                    else:
                        wait 5s
                        goto_next_level
                fight
                passed
                next
                    new_map
        except level_low:
            return
            
        win = fight
        if not win:
            return
            
        
monitor
find_all_pos
find_then_click





# TODO
每一个窗口都能独立工作，
但提供一些接口，可以和主控打配合


写个自动刷buff的程序    done


findtimeout     done
    append to task_list
    
    if not in exception list:
        add to exception_list
    else:
        if restart_count < 3:
            count ++
            restart game
        else:
            raise restart_too_much

    goto主界面


重构 goto_main    done
    for i in range(5)
        try:
            find close, setting
            if close:
                click
                if find setting
                    return 
            else:
                return 
        except:
            esc
            sleep(1)

    if restart_count < 3:
        count ++
        restart game
    else:
        raise restart_too_much


说下我的看法，我们公会：

加分项：
加了微信群，好沟通
战力高（500w以上）
可以卡点放队伍(提前几十秒放）
能买隐藏

减分项：
不活跃，不签到，不捐赠
公会战进入战争时期，还把高战分散到不同队伍中
提前很长时间就驻军，送人头
战力低，还往银行、地堡驻军，浪费队伍



# TODO list：
用户体验
    1. 文档有详细使用说明
    2. 文档有异常处理
    3. 出现异常，游戏不要报代码错，而是友好的用户提示

代码优化
    log有重复的，简化一下
    
    
优化竞技场
jingjichang
    enter
    for i in range(7)
        fight
        fight3
        start_fight
        card or reach_max
        if card
            card
            ok
        else
            close
            reflesh
            fight3
            start_fight
            card
            ok
            
jingjichang
    enter
    win, lose = 0, 0
    page = 0
    for i in range(7)
        page = choose_opponent(page)
        win = do_fight
        if win:
            win += 1
        else:
            lose += 1
            page += 1

choose_opponent
    fight
    while true:
        for _ in range(page):
            click reflesh
        fight3
        start_fight
        if reach_max or close
            close
            page += 1
            continue
        else:
            break
    return page
            
do_fight
    2 
    go_last
    card
    
    
main
    启动模拟器（如果已启动，则跳过）
    启动4个player（task_list)
    
auto_play
    启动游戏（如果已启动，则跳过）
    play_game
    (遇到异常可以回到主界面，或者重启游戏）

player
    操作游戏（hand，eye）
    
tasks
    各种游戏任务
        test
        run
        
可以优化的点：
    把所有任务提取到tasks文件中，作为类
    
    只保留最近3天的log
    
    每个任务完成了，记录下
    
    
    # TODO 钻石不够，会进入vip商店
    
    只保留最近3天的日志 （可以配置）
        
        
    
玩家建议：
@缘、六星币 那个任务栏刷新可以改掉，要是十来个任务，一次就浪费五百个钻石了

第四个秘书之后，功能有问题

宝石碎片必买

可以一次性完成任务

交任务的时候，看下哪个没完成

那个非vip，任务栏不要领6、7星任务
任务刷新次数做到可以配置



问题：
go_back via esc 可能会失败

xianshijie 切换大地图有问题

低等级可能有问题

启动失败，要能重新启动

出现问题，要截取最近2分钟的日志，这样才方便

好友有多个boos，但只打一个


研究下别人的：
本辅助试用版体验下载地址：
链接：https://pan.baidu.com/s/1Y_7e17v-Vld-A0JsyBOJzQ
提取码：mori

S4220

轮流登陆
    account_setting.cfg
    g_pics = {}  缓存所有图片
    pending = set()
    running = set()
    done = set()
    win_num = 3
    
    
    主控
        从桌面启动
            启动模拟器
        
        timeout = 60
        count = 0
        while true:
            monitor setting, liulanqi
            sleep 5
            if find:
                wind = 
                role =     # 用户没有配置，就用默认
                player = 
                
                启动auto_play
            
            timeout = 10
            count += 1
            if count >= win_num:
                break
        
        while true
            开始监控done_q
            有完成的
                add to done
                rm_from_pending
                show progress
                if pengding
                    就再启动一个 (role)
                    add to running
                if not running
                    break

        
    player
        获取任务
        if 游戏未启动
            启动游戏
        else:
            go_to_main

        玩游戏
        发送一个done到q_out
        从q_in中再取一个任务
        换号登陆
        
    如何处理登陆冲突
    
★ 建立 window 类，role 类

role 怎么创建、管理？
-> (game, user)


优化以下logger
    消除重复log

    